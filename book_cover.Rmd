---
editor_options: 
  chunk_output_type: console
---

```{r, echo = FALSE, cache=FALSE, warning = FALSE, message=FALSE, fig.width = 8, fig.height=10}
library(tibble)
library(dplyr)
library(purrr)
library(tidyr)
library(forcats)
library(ggplot2)

# import from file --------------------------------------------------------
df_long <- read.csv2("progress_data.csv", stringsAsFactors = FALSE, 
                      header = TRUE) %>% 
  as_tibble() %>% 
  modify_at("status", factor,
            levels = c("open", "started", "solved", "reviewed", "finalised")) %>% 
  tibble::rowid_to_column("id") %>% 
  separate(chapter, "nr", sep = " ", remove = FALSE, extra = "drop") %>% 
  mutate(nr = as.integer(nr), 
         chapter = factor(chapter),
         chapter = fct_reorder(chapter, nr, .desc = TRUE),
         part = case_when(nr < 9 ~ "Foundations",
                          nr < 12 ~ "FP",
                          nr < 17 ~ "OOP",
                          nr < 22 ~ "Metapr.",
                          TRUE    ~ "Techn."),
         part = factor(part, levels = c("Foundations", "FP", "OOP",
                                        "Metapr.", "Techn.")))

# Intermediate calculations
percent_solved <- mean(df_long$status %in% c("solved", "reviewed", "finalised"), na.rm = TRUE) * 100
percent_reviewed <- mean(df_long$status %in% c("reviewed", "finalised"), na.rm = TRUE) * 100

# Create Plot
plot_progress <- df_long %>% 
  ggplot(aes(x = chapter, fill = status, group = -id,
             subchapter = subchapter, exercise = exercise,
             credits = credits)) +
  coord_flip() +
  geom_bar(color = "white") +
  scale_y_continuous(expand = c(0, 0)) +
  theme_bw(base_size = 14) +
  theme(legend.position = "bottom",
        # legend.justification = c(0, 1),
        strip.background = element_rect(fill = "#EFEFEF"),
        strip.placement = "outside",
        axis.text.x = element_blank(),
        axis.text.y = element_text(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        # plot.title = element_text(hjust = 2.5),
        panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  guides(color = FALSE,
         fill = guide_legend(nrow = 1)) +
  scale_fill_manual(values = c("#F99992", "#fdcc8a", "#bae4b3", "#74c476", "#238b45"),
                    drop = FALSE) +
  labs(title = paste0("Solved Exercises: ",
                     round(percent_solved, 1),
                     "% (2nd Edition)"),
       subtitle = paste0("Reviewed: ",
                     round(percent_reviewed, 1),
                     "%"),
       caption = paste0("(Open: ",
                         sum(df_long$status == "open"),
                         " | Started: ",
                         sum(df_long$status == "started"),
                         " | Solved: ",
                         sum(df_long$status %in% c("solved", "reviewed", "finalised")),
                         " | Reviewed: ",
                         sum(df_long$status %in% c("reviewed", "finalised")),
                         " | Finalised: ",
                         sum(df_long$status == "finalised"),
                        ")"),
       fill = "Status:")

# Create static plot (including facets for parts)
plot_progress + 
  facet_grid(part ~ ., scales = "free",
             space = "free", switch = "both")
```